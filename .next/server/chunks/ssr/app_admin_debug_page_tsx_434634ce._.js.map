{"version":3,"sources":["turbopack:///[project]/app/admin/debug/page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport { useState } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { supabase } from '@/lib/supabase/client'\r\n\r\nexport default function DebugPage() {\r\n    const [logs, setLogs] = useState<string[]>([])\r\n    const [loading, setLoading] = useState(false)\r\n\r\n    const addLog = (msg: string) => setLogs(prev => [...prev, `${new Date().toISOString().split('T')[1]} - ${msg}`])\r\n\r\n    const runTest = async () => {\r\n        setLoading(true)\r\n        setLogs([])\r\n        addLog('üöÄ Starting connection test...')\r\n\r\n        try {\r\n            // 1. Check Env Vars\r\n            addLog('Checking environment variables...')\r\n            const url = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n            const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n            if (!url) addLog('‚ùå NEXT_PUBLIC_SUPABASE_URL is missing')\r\n            else addLog(`‚úÖ URL found: ${url.substring(0, 15)}...`)\r\n\r\n            if (!key) addLog('‚ùå NEXT_PUBLIC_SUPABASE_ANON_KEY is missing')\r\n            else addLog('‚úÖ Key found')\r\n\r\n            if (!url || !key) throw new Error('Missing credentials')\r\n\r\n            // 2. Test Supabase Client\r\n            addLog('Testing Supabase Client query...')\r\n            const { data, error } = await supabase.from('testimonials').select('count', { count: 'exact', head: true })\r\n\r\n            if (error) {\r\n                addLog('‚ùå Query failed!')\r\n                addLog(`Error: ${JSON.stringify(error, null, 2)}`)\r\n                console.error('Debug Query Error:', error)\r\n            } else {\r\n                addLog('‚úÖ Query successful!')\r\n                addLog(`Data: ${JSON.stringify(data)}`)\r\n            }\r\n\r\n            // 3. Test Direct Fetch (Bypass Client)\r\n            addLog('Testing direct fetch...')\r\n            const directUrl = `${url}/rest/v1/testimonials?select=*&limit=1`\r\n            const response = await fetch(directUrl, {\r\n                headers: {\r\n                    'apikey': key,\r\n                    'Authorization': `Bearer ${key}`\r\n                }\r\n            })\r\n\r\n            addLog(`Fetch status: ${response.status}`)\r\n            if (!response.ok) {\r\n                const text = await response.text()\r\n                addLog(`Fetch error body: ${text}`)\r\n            } else {\r\n                const json = await response.json()\r\n                addLog('‚úÖ Direct fetch successful')\r\n            }\r\n\r\n        } catch (err: any) {\r\n            addLog(`‚ùå Test crashed: ${err.message}`)\r\n            console.error(err)\r\n        } finally {\r\n            setLoading(false)\r\n            addLog('üèÅ Test complete')\r\n        }\r\n    }\r\n\r\n    const sqlFix = `-- Run this in your Supabase SQL Editor to fix the recursion error:\r\n\r\nCREATE OR REPLACE FUNCTION public.get_current_user_role()\r\nRETURNS text\r\nLANGUAGE plpgsql\r\nSECURITY DEFINER\r\nSET search_path = public\r\nAS $$\r\nDECLARE\r\n  _role text;\r\nBEGIN\r\n  IF auth.uid() IS NULL THEN RETURN NULL; END IF;\r\n  SELECT role INTO _role FROM profiles WHERE id = auth.uid();\r\n  RETURN _role;\r\nEND;\r\n$$;\r\n\r\nDROP POLICY IF EXISTS \"Admins and editors can manage testimonials\" ON testimonials;\r\nCREATE POLICY \"Admins and editors can manage testimonials\" ON testimonials FOR ALL USING (\r\n  get_current_user_role() IN ('admin', 'editor')\r\n);\r\n\r\n-- Repeat for other tables (services, portfolio_items, etc) using get_current_user_role()\r\n-- See supabase/migrations/20250128000002_fix_rls_recursion.sql for full script\r\n`\r\n\r\n    return (\r\n        <div className=\"p-8 max-w-4xl mx-auto space-y-6\">\r\n            <h1 className=\"text-2xl font-bold\">Supabase Connection Debugger</h1>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"p-4 border rounded bg-secondary/10\">\r\n                        <p className=\"mb-4\">Click the button below to run a comprehensive connection test.</p>\r\n                        <Button onClick={runTest} disabled={loading}>\r\n                            {loading ? 'Running...' : 'Run Diagnostics'}\r\n                        </Button>\r\n                    </div>\r\n\r\n                    <div className=\"bg-black/90 text-green-400 p-4 rounded-lg font-mono text-sm min-h-[300px] overflow-auto whitespace-pre-wrap\">\r\n                        {logs.length === 0 ? 'Ready to test...' : logs.join('\\n')}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"p-4 border rounded bg-blue-500/10 border-blue-200\">\r\n                        <h2 className=\"font-bold mb-2\">üí° How to fix \"Infinite Recursion\"</h2>\r\n                        <p className=\"text-sm mb-4\">\r\n                            If you see <code>infinite recursion detected</code>, it means your database policies are stuck in a loop.\r\n                            Run the SQL below in your Supabase Dashboard to fix it.\r\n                        </p>\r\n                        <div className=\"relative\">\r\n                            <pre className=\"bg-secondary p-4 rounded text-xs overflow-auto max-h-[300px]\">\r\n                                {sqlFix}\r\n                            </pre>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"secondary\"\r\n                                className=\"absolute top-2 right-2\"\r\n                                onClick={() => {\r\n                                    navigator.clipboard.writeText(sqlFix)\r\n                                    alert('SQL copied to clipboard!')\r\n                                }}\r\n                            >\r\n                                Copy SQL\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n"],"names":[],"mappings":"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"}