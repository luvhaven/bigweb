{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/bigweb-ff2/app/admin/debug/page.tsx"],"sourcesContent":["'use client'\r\n\r\nimport { useState } from 'react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { supabase } from '@/lib/supabase/client'\r\n\r\nexport default function DebugPage() {\r\n    const [logs, setLogs] = useState<string[]>([])\r\n    const [loading, setLoading] = useState(false)\r\n\r\n    const addLog = (msg: string) => setLogs(prev => [...prev, `${new Date().toISOString().split('T')[1]} - ${msg}`])\r\n\r\n    const runTest = async () => {\r\n        setLoading(true)\r\n        setLogs([])\r\n        addLog('üöÄ Starting connection test...')\r\n\r\n        try {\r\n            // 1. Check Env Vars\r\n            addLog('Checking environment variables...')\r\n            const url = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n            const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\n            if (!url) addLog('‚ùå NEXT_PUBLIC_SUPABASE_URL is missing')\r\n            else addLog(`‚úÖ URL found: ${url.substring(0, 15)}...`)\r\n\r\n            if (!key) addLog('‚ùå NEXT_PUBLIC_SUPABASE_ANON_KEY is missing')\r\n            else addLog('‚úÖ Key found')\r\n\r\n            if (!url || !key) throw new Error('Missing credentials')\r\n\r\n            // 2. Test Supabase Client\r\n            addLog('Testing Supabase Client query...')\r\n            const { data, error } = await supabase.from('testimonials').select('count', { count: 'exact', head: true })\r\n\r\n            if (error) {\r\n                addLog('‚ùå Query failed!')\r\n                addLog(`Error: ${JSON.stringify(error, null, 2)}`)\r\n                console.error('Debug Query Error:', error)\r\n            } else {\r\n                addLog('‚úÖ Query successful!')\r\n                addLog(`Data: ${JSON.stringify(data)}`)\r\n            }\r\n\r\n            // 3. Test Direct Fetch (Bypass Client)\r\n            addLog('Testing direct fetch...')\r\n            const directUrl = `${url}/rest/v1/testimonials?select=*&limit=1`\r\n            const response = await fetch(directUrl, {\r\n                headers: {\r\n                    'apikey': key,\r\n                    'Authorization': `Bearer ${key}`\r\n                }\r\n            })\r\n\r\n            addLog(`Fetch status: ${response.status}`)\r\n            if (!response.ok) {\r\n                const text = await response.text()\r\n                addLog(`Fetch error body: ${text}`)\r\n            } else {\r\n                const json = await response.json()\r\n                addLog('‚úÖ Direct fetch successful')\r\n            }\r\n\r\n        } catch (err: any) {\r\n            addLog(`‚ùå Test crashed: ${err.message}`)\r\n            console.error(err)\r\n        } finally {\r\n            setLoading(false)\r\n            addLog('üèÅ Test complete')\r\n        }\r\n    }\r\n\r\n    const sqlFix = `-- Run this in your Supabase SQL Editor to fix the recursion error:\r\n\r\nCREATE OR REPLACE FUNCTION public.get_current_user_role()\r\nRETURNS text\r\nLANGUAGE plpgsql\r\nSECURITY DEFINER\r\nSET search_path = public\r\nAS $$\r\nDECLARE\r\n  _role text;\r\nBEGIN\r\n  IF auth.uid() IS NULL THEN RETURN NULL; END IF;\r\n  SELECT role INTO _role FROM profiles WHERE id = auth.uid();\r\n  RETURN _role;\r\nEND;\r\n$$;\r\n\r\nDROP POLICY IF EXISTS \"Admins and editors can manage testimonials\" ON testimonials;\r\nCREATE POLICY \"Admins and editors can manage testimonials\" ON testimonials FOR ALL USING (\r\n  get_current_user_role() IN ('admin', 'editor')\r\n);\r\n\r\n-- Repeat for other tables (services, portfolio_items, etc) using get_current_user_role()\r\n-- See supabase/migrations/20250128000002_fix_rls_recursion.sql for full script\r\n`\r\n\r\n    return (\r\n        <div className=\"p-8 max-w-4xl mx-auto space-y-6\">\r\n            <h1 className=\"text-2xl font-bold\">Supabase Connection Debugger</h1>\r\n\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"p-4 border rounded bg-secondary/10\">\r\n                        <p className=\"mb-4\">Click the button below to run a comprehensive connection test.</p>\r\n                        <Button onClick={runTest} disabled={loading}>\r\n                            {loading ? 'Running...' : 'Run Diagnostics'}\r\n                        </Button>\r\n                    </div>\r\n\r\n                    <div className=\"bg-black/90 text-green-400 p-4 rounded-lg font-mono text-sm min-h-[300px] overflow-auto whitespace-pre-wrap\">\r\n                        {logs.length === 0 ? 'Ready to test...' : logs.join('\\n')}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"space-y-4\">\r\n                    <div className=\"p-4 border rounded bg-blue-500/10 border-blue-200\">\r\n                        <h2 className=\"font-bold mb-2\">üí° How to fix \"Infinite Recursion\"</h2>\r\n                        <p className=\"text-sm mb-4\">\r\n                            If you see <code>infinite recursion detected</code>, it means your database policies are stuck in a loop.\r\n                            Run the SQL below in your Supabase Dashboard to fix it.\r\n                        </p>\r\n                        <div className=\"relative\">\r\n                            <pre className=\"bg-secondary p-4 rounded text-xs overflow-auto max-h-[300px]\">\r\n                                {sqlFix}\r\n                            </pre>\r\n                            <Button\r\n                                size=\"sm\"\r\n                                variant=\"secondary\"\r\n                                className=\"absolute top-2 right-2\"\r\n                                onClick={() => {\r\n                                    navigator.clipboard.writeText(sqlFix)\r\n                                    alert('SQL copied to clipboard!')\r\n                                }}\r\n                            >\r\n                                Copy SQL\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAMe,SAAS;IACpB,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAW,EAAE;IAC7C,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IAEvC,MAAM,SAAS,CAAC,MAAgB,QAAQ,CAAA,OAAQ;mBAAI;gBAAM,GAAG,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,GAAG,EAAE,KAAK;aAAC;IAE/G,MAAM,UAAU;QACZ,WAAW;QACX,QAAQ,EAAE;QACV,OAAO;QAEP,IAAI;YACA,oBAAoB;YACpB,OAAO;YACP,MAAM;YACN,MAAM;YAEN;;iBACK,OAAO,CAAC,aAAa,EAAE,IAAI,SAAS,CAAC,GAAG,IAAI,GAAG,CAAC;YAErD;;iBACK,OAAO;YAEZ;;YAEA,0BAA0B;YAC1B,OAAO;YACP,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,4IAAQ,CAAC,IAAI,CAAC,gBAAgB,MAAM,CAAC,SAAS;gBAAE,OAAO;gBAAS,MAAM;YAAK;YAEzG,IAAI,OAAO;gBACP,OAAO;gBACP,OAAO,CAAC,OAAO,EAAE,KAAK,SAAS,CAAC,OAAO,MAAM,IAAI;gBACjD,QAAQ,KAAK,CAAC,sBAAsB;YACxC,OAAO;gBACH,OAAO;gBACP,OAAO,CAAC,MAAM,EAAE,KAAK,SAAS,CAAC,OAAO;YAC1C;YAEA,uCAAuC;YACvC,OAAO;YACP,MAAM,YAAY,GAAG,IAAI,sCAAsC,CAAC;YAChE,MAAM,WAAW,MAAM,MAAM,WAAW;gBACpC,SAAS;oBACL,UAAU;oBACV,iBAAiB,CAAC,OAAO,EAAE,KAAK;gBACpC;YACJ;YAEA,OAAO,CAAC,cAAc,EAAE,SAAS,MAAM,EAAE;YACzC,IAAI,CAAC,SAAS,EAAE,EAAE;gBACd,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,OAAO,CAAC,kBAAkB,EAAE,MAAM;YACtC,OAAO;gBACH,MAAM,OAAO,MAAM,SAAS,IAAI;gBAChC,OAAO;YACX;QAEJ,EAAE,OAAO,KAAU;YACf,OAAO,CAAC,gBAAgB,EAAE,IAAI,OAAO,EAAE;YACvC,QAAQ,KAAK,CAAC;QAClB,SAAU;YACN,WAAW;YACX,OAAO;QACX;IACJ;IAEA,MAAM,SAAS,CAAC;;;;;;;;;;;;;;;;;;;;;;;;AAwBpB,CAAC;IAEG,qBACI,8OAAC;QAAI,WAAU;;0BACX,8OAAC;gBAAG,WAAU;0BAAqB;;;;;;0BAEnC,8OAAC;gBAAI,WAAU;;kCACX,8OAAC;wBAAI,WAAU;;0CACX,8OAAC;gCAAI,WAAU;;kDACX,8OAAC;wCAAE,WAAU;kDAAO;;;;;;kDACpB,8OAAC,4IAAM;wCAAC,SAAS;wCAAS,UAAU;kDAC/B,UAAU,eAAe;;;;;;;;;;;;0CAIlC,8OAAC;gCAAI,WAAU;0CACV,KAAK,MAAM,KAAK,IAAI,qBAAqB,KAAK,IAAI,CAAC;;;;;;;;;;;;kCAI5D,8OAAC;wBAAI,WAAU;kCACX,cAAA,8OAAC;4BAAI,WAAU;;8CACX,8OAAC;oCAAG,WAAU;8CAAiB;;;;;;8CAC/B,8OAAC;oCAAE,WAAU;;wCAAe;sDACb,8OAAC;sDAAK;;;;;;wCAAkC;;;;;;;8CAGvD,8OAAC;oCAAI,WAAU;;sDACX,8OAAC;4CAAI,WAAU;sDACV;;;;;;sDAEL,8OAAC,4IAAM;4CACH,MAAK;4CACL,SAAQ;4CACR,WAAU;4CACV,SAAS;gDACL,UAAU,SAAS,CAAC,SAAS,CAAC;gDAC9B,MAAM;4CACV;sDACH;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAS7B","debugId":null}}]
}